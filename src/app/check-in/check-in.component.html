<div class="check-in-container">
  <h2>Check-in khuôn mặt</h2>

  <div class="mode-toggle">
    <button (click)="toggleMode('camera')" [class.active]="currentMode === 'camera'">Camera</button>
    <button (click)="toggleMode('file')" [class.active]="currentMode === 'file'">Upload File</button>
  </div>

  <div class="video-container" [style.display]="currentMode === 'camera' ? 'block' : 'none'">
    <video #videoElement autoplay playsinline></video>
    <canvas #canvasElement></canvas>
    @if (loading || loaddingModels) {
      <div class="loading-overlay">
        <div class="spinner"></div>
        <p>Đang xử lý...</p>
      </div>
    }
    <div class="face-detection-overlay" [class.face-valid]="faceValid" [class.face-invalid]="!faceValid && !loading && !loaddingModels" [class.face-detecting]="faceDetecting"></div>
  </div>

  <div class="file-upload-container" [style.display]="currentMode === 'file' ? 'flex' : 'none'"
       (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)"
       [class.drag-hover]="isDragging">
    <input type="file" (change)="onFileSelected($event)" accept="image/*" [attr.multiple]="false" #fileInput style="display: none;">
    <div class="file-upload-area" (click)="fileInput.click()">
      <canvas #fileCanvasElement></canvas>
      @if (!selectedFile && !loaddingModels) {
        <p class="placeholder-text">Kéo thả ảnh vào đây hoặc click để chọn</p>
      }
      @if (loading || loaddingModels) {
        <div class="loading-overlay">
          <div class="spinner"></div>
          <p>Đang xử lý...</p>
        </div>
      }
      <div class="face-detection-overlay" [class.face-valid]="faceValid" [class.face-invalid]="!faceValid && selectedFile && !loading && !loaddingModels" [class.face-detecting]="faceDetecting"></div>
    </div>
  </div>

  <button (click)="currentMode === 'camera' ? handleCheckIn() : handleFileCheckIn()" [disabled]="loading || !faceValid">
    {{ currentMode === 'camera' ? 'Check-in từ Camera' : 'Check-in từ File' }}
  </button>

@if (checkInResult) {
  <div class="result">
    {{ checkInResult }}
  </div>
}

  <section class="registration-section">
    <h3>Đăng ký khách hàng</h3>
    <p class="registration-description">
      Đăng ký khuôn mặt cho khách hàng mới để sử dụng tính năng check-in.
    </p>

    <form class="registration-form" (submit)="handleRegistrationSubmit($event)" novalidate>
      <div class="form-group">
        <label for="registrationName">Họ và tên</label>
        <input
          id="registrationName"
          type="text"
          name="registrationName"
          [(ngModel)]="registrationName"
          placeholder="Nguyễn Văn A"
          [disabled]="registrationLoading"
          autocomplete="off"
        >
      </div>

      <div class="form-group">
        <label for="registrationCode">Mã khách hàng</label>
        <input
          id="registrationCode"
          type="text"
          name="registrationCode"
          [(ngModel)]="registrationCode"
          placeholder="KH001"
          [disabled]="registrationLoading"
          autocomplete="off"
        >
      </div>

      <div class="form-group">
        <label>Ảnh khuôn mặt</label>
        <div class="file-selector" [class.disabled]="registrationLoading">
          <button
            type="button"
            class="outline"
            (click)="triggerRegistrationFilePicker()"
            [disabled]="registrationLoading"
          >
            Chọn ảnh
          </button>
          <span class="file-name" [class.placeholder]="!registrationFile">
            {{ registrationFile?.name || 'Chưa chọn file' }}
          </span>
          @if (registrationFile) {
            <button
              type="button"
              class="link"
              (click)="clearRegistrationFile()"
              [disabled]="registrationLoading"
            >
              Xóa
            </button>
          }
        </div>
        <input
          type="file"
          #registrationFileInput
          accept="image/*"
          (change)="onRegistrationFileSelected($event)"
          hidden
        >
      </div>

      <button type="submit" [disabled]="isRegistrationDisabled">
        {{ registrationLoading ? 'Đang đăng ký...' : 'Đăng ký khách hàng' }}
      </button>
    </form>

    @if (registrationResult) {
      <div class="registration-result" [ngClass]="registrationStatus">
        {{ registrationResult }}
      </div>
    }
  </section>
</div>
